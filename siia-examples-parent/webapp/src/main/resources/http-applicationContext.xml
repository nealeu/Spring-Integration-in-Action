<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:int-http="http://www.springframework.org/schema/integration/http"
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:p="http://www.springframework.org/schema/p"
	xmlns:mvc="http://www.springframework.org/schema/mvc"
	xsi:schemaLocation="http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http-2.0.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.0.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver"/>

    <!-- This creates a bean that is a Spring Controller -->    
    <int-http:inbound-channel-adapter id="httpSmsSubscriptionController" 
        channel="inboundHttpChannel"
        supported-methods="GET,POST" 
        name="/sms/subscribe"
        view-name="confirmReceived" 
        />

    <!-- This creates a bean that is a Spring HttpRequestHandler -->    
    <int-http:inbound-channel-adapter id="httpSmsSubscriptionRequestHandler" 
        channel="inboundHttpChannel"
        supported-methods="GET,POST" 
        name="/sms-api/subscribe"
        />

	<bean name="/static/*" class="org.springframework.web.servlet.resource.ResourceHttpRequestHandler" p:locations="/static/"  />
	<!-- NOTE: mvc:resources has side effects we don't want - TRY it instead of line above! -->
<!--	<mvc:resources location="/static/" mapping="/static/**"/>-->
        
    <int:channel id="inboundHttpChannel"/>

	<int:map-to-object-transformer type="com.manning.siia.domain.notification.SmsSubscriptionRequest" 
		input-channel="inboundHttpChannel"
		output-channel="smsSubscriptionRequests"
		/>
    
    <int:channel id="smsSubscriptionRequests"  datatype="com.manning.siia.domain.notification.SmsSubscriptionRequest"/>
    
    <int:filter id="validationFilter" expression="payload.mobileNumber.startsWith('+')" throw-exception-on-rejection="true" 
    	input-channel="smsSubscriptionRequests" output-channel="validatedSmsSubscriptionRequests">
	</int:filter>

    <int:channel  id="validatedSmsSubscriptionRequests" datatype="com.manning.siia.domain.notification.SmsSubscriptionRequest">
        <int:queue capacity="2"/>
    </int:channel> 
</beans>